# Proposal 9: 크롤링 엔진 안정성 강화를 위한 제안

## 1. 문제 분석

`back_front.log` 파일 분석 결과, 현재 크롤링 엔진은 두 가지 주요 문제를 겪고 있습니다.

1.  **데이터베이스 `page_id` 저장 오류**:
    - **현상**: 크롤링 후 제품 정보를 데이터베이스에 저장할 때, 실제 웹사이트의 페이지 번호(예: 482)가 아닌 내부 인덱스 값(`0`)이 `page_id`로 잘못 저장됩니다.
    - **영향**: 이로 인해 후속 크롤링 시, 시스템은 마지막으로 크롤링한 위치를 정확히 파악하지 못합니다. `intelligent range calculation` 로직이 잘못된 `page_id`를 기반으로 다음 크롤링 범위를 계산하여, 이미 수집한 데이터를 중복으로 처리하거나 새로운 데이터를 누락하는 원인이 됩니다.

2.  **후속 크롤링 시 URL 수집 실패**:
    - **현상**: 첫 번째 크롤링 세션에서는 정상적으로 제품 URL을 수집하지만, 이어서 실행된 두 번째 크롤링 세션의 2단계(Stage 2)에서는 페이지 HTML을 성공적으로 내려받고도 URL을 전혀 추출하지 못하는 문제가 발생합니다 (`0 product URLs collected`).
    - **영향**: 크롤링이 더 이상 진행되지 않고 멈추게 됩니다. 이는 상태 관리 로직이 올바르게 초기화되지 않거나, 이전 세션의 상태가 다음 세션에 잘못된 영향을 미치기 때문일 가능성이 높습니다.

## 2. 해결 방안

위 문제들을 해결하고 크롤링 엔진의 안정성을 확보하기 위해 다음 두 가지 핵심 사항을 제안합니다.

### 제안 1: `page_id` 저장 로직 수정 (P0 - 긴급)

- **목표**: 제품 정보를 데이터베이스에 저장할 때, 실제 페이지 번호를 정확히 기록하도록 수정합니다.
- **실행 계획**:
    1.  **`ProductDetail` 구조체 및 관련 타입 검토**: `ProductDetail` 구조체에 `page_id` 필드가 올바르게 포함되어 있는지 확인합니다.
    2.  **URL 수집 단계 (Stage 2) 검토**: `collect_product_urls_from_html`과 같은 함수에서 제품 URL을 추출할 때, 해당 URL이 속한 페이지 번호(`page_id`)도 함께 결과로 반환하도록 수정합니다.
    3.  **상세 정보 수집 단계 (Stage 3) 수정**: 2단계에서 전달받은 `page_id`를 `ProductDetail` 객체에 포함하여 다음 단계로 전달합니다.
    4.  **데이터베이스 저장 단계 (Stage 4) 수정**: `save_product_details` 또는 관련 저장 함수에서 `ProductDetail` 객체에 포함된 `page_id` 값을 데이터베이스 `products` 테이블의 `page_id` 컬럼에 정확히 저장하도록 SQL 쿼리 및 로직을 수정합니다. `INSERT` 또는 `UPDATE` 문에 `page_id`가 포함되어 있는지 반드시 확인해야 합니다.

### 제안 2: 크롤링 세션 간 상태 격리 보장 (P1 - 중요)

- **목표**: 각 크롤링 세션이 독립적인 상태를 갖도록 보장하여, 이전 세션의 결과가 다음 세션에 영향을 주지 않도록 합니다.
- **실행 계획**:
    1.  **상태 관리 객체 분석**: 크롤링 파이프라인(Stage 0-4) 전반에서 사용되는 상태 관리 객체(예: `SharedStateCache`, `CrawlingContext` 등)를 식별합니다.
    2.  **URL 수집 로직(Stage 2) 리팩토링**:
        - 현재 Stage 2 내부에서 불필요하게 전체 사이트 분석(`enhanced page discovery algorithm`)을 다시 수행하는 로직을 제거합니다. Stage 2는 **주어진 범위의 페이지들로부터 URL을 수집하는 책임**에만 집중해야 합니다.
        - 각 페이지를 파싱하여 URL을 추출하는 함수의 입력과 출력을 명확히 정의하고, 외부 상태에 대한 의존성을 최소화합니다. 페이지 HTML 내용과 해당 페이지 번호를 입력받아, 추출된 URL 목록을 반환하는 순수 함수 형태로 변경하는 것을 권장합니다.
    3.  **세션 초기화 로직 강화**: `start_crawling` 함수가 호출될 때마다, 해당 세션에서 사용할 상태 객체들이나 결과 수집용 변수(예: URL을 담는 `Vec`)가 항상 깨끗한 상태로 초기화되도록 보장합니다.

## 3. 기대 효과

- **정확한 증분 크롤링**: `page_id`가 올바르게 저장되어, 시스템이 마지막으로 중단된 지점부터 정확하게 크롤링을 재개할 수 있습니다.
- **크롤링 연속성 보장**: 세션 간 상태 격리를 통해 URL 수집 실패 문제를 해결하여, 크롤링이 중단 없이 안정적으로 수행될 수 있습니다.
- **코드 명확성 및 유지보수성 향상**: 각 단계의 책임과 데이터 흐름을 명확히 하여 코드의 복잡도를 낮추고 유지보수를 용이하게 합니다.
